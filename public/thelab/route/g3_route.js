function G3RouteUi(){var a=new G3RouteRoutes,b=function(){$("p.warning").remove();g3_route.el.append("<div/>");g3_route.el.css({position:"relative"}).find("div").css({position:"absolute",top:0,left:0,bottom:0,right:0});g3.is_touch_device()?g3_route.el.find("div").bind("touchstart",function(b){b.originalEvent.touches.length>0&&$.each(b.originalEvent.touches,function(c,d){var f=g3.pos(d.pageX,d.pageY,$(b.target).parent());a.add(f.x,f.y)})}):g3_route.el.find("div").bind("mousedown",function(b){var c=g3.pos(b.pageX,b.pageY,$(b.target).parent());a.add(c.x,c.y)})};b()}function G3RouteRoutes(){var a=[],b=[],c=0,d=null,e=g3_route.svg.group(g3_route.svg.root(),{id:"routes"});this.add=function(c,g){var h=g3_route.svg.circle(e,c,g,5,{fill:"#ddd"});a.push({x:c,y:g,circle:h});if(a.length>1){b.push(new G3RouteRoute(a[a.length-2],a[a.length-1],e,b.length));b[b.length-1].init();d=setInterval(f,200)}};var f=function(){b[c].state()=="ready"&&b[c].render();b[c].state()=="start_next"&&c++;c>=b.length&&(c=0)};this.reset=function(){};this.routes_el=function(){return e};this.route_count=function(){return b.length}}function G3RouteRoute(a,b,c,d,e){var f,g,h,i,j=[],k=[],l=null,m=0,n={},o=13,p=40,q=!1,r=$(g3_route.svg.group(c,{id:d})),s=null;this.init=function(){f=a;g=b;x();w();s="ready"};this.render=function(){m=0;k=[];t()};this.state=function(){return s};var t=function(){s="build";m++;if(m>j.length-1){clearTimeout(l);m=0;var a=g3_route.svg.circle(c,g.x,g.y,5,{fill:"#D1004A",opacity:1});$(a).animate({svgR:15,svgOpacity:0},600,"linear",function(){$(this).remove()});u();s="clear"}else l=setTimeout(function(){v();t()},o)},u=function(){if(m>=j.length){clearTimeout(l);l=setTimeout(function(){s="ready"},o)}else{clearTimeout(l);l=setTimeout(function(){$(k[m]).remove();delete k[m];u();m++;m>p/2&&(s="start_next")},o)}},v=function(){k.push(g3_route.svg.line(r,j[m].x,j[m].y,j[m-1].x,j[m-1].y,{"stroke-width":j[m].weight,stroke:"#444","stroke-linecap":"round"}))};this.reset=function(){};var w=function(){if(f!=0&&g!=0){var a=1,b=5/(p/1.1)*2,c={x:0,y:0},d={x:f.x,y:f.y};for(var e=0;e<=1+1/p;e+=1/p){c.x=Math.pow(e,3)*(g.x+3*(h.x-i.x)-f.x)+3*Math.pow(e,2)*(f.x-2*h.x+i.x)+3*e*(h.x-f.x)+f.x;c.y=Math.pow(e,3)*(g.y+3*(h.y-i.y)-f.y)+3*Math.pow(e,2)*(f.y-2*h.y+i.y)+3*e*(h.y-f.y)+f.y;j.push({x:c.x,y:c.y,weight:a});e>(1+1/p)/2?a-=b:a+=b}}},x=function(){h=g3.getInnerPoint(f,g,1.25);i=g3.getInnerPoint(f,g,1.75);h.y-=40;i.y-=40},y=function(){var a=g3_route.svg.group(r,{id:"route_debug"});g3_route.svg.line(a,f.x,f.y,h.x,h.y,{strokeWidth:1,stroke:"#f00"});g3_route.svg.line(a,h.x,h.y,i.x,i.y,{strokeWidth:1,stroke:"#0f0"});g3_route.svg.line(a,i.x,i.y,g.x,g.y,{strokeWidth:1,stroke:"#00f"})}}var g3_route={};$(document).ready(function(){g3_route.init($(".lab"),"thelab/g3_route/")});g3_route.init=function(a,b){g3_route.url=b;g3_route.el=a;g3_route.el.svg({width:100,height:500,onLoad:g3_route.launch})};g3_route.launch=function(a){g3_route.svg=a;g3_route.ui=new G3RouteUi};var g3={getBBoxCentre:function(a){return{x:a.position().left+a[0].getBBox().width/2,y:a.position().top+a[0].getBBox().height/2}},drawBBox:function(a){g3_route.svg.rect(a.position().left,a.position().top,a[0].getBBox().width,a[0].getBBox().height,{stroke:"green",fill:"none"})},objLength:function(a){var b,c=0;for(b in a)c+=Number(a.hasOwnProperty(b));return c},getVector:function(a,b){var c=a.x-b.x,d=a.y-b.y;return{x:c,y:d,length:Math.abs(Math.sqrt(c*c+d*d))}},getInnerPoint:function(a,b,c){var d={x:0,y:0},e=g3.getVector(a,b);d.y=e.y/c+b.y;d.x=e.x/c+b.x;return d},is_touch_device:function(){return typeof window.ontouchstart!="undefined"?!0:!1},pos:function(a,b,c){var d=a-c.offset().left,e=b-c.offset().top;return{x:d,y:e}}};